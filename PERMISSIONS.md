# 权限说明文档

## 角色体系

系统中有两种角色体系：

### 1. 系统级角色（User.role）
- **SUPER_ADMIN** - 超级管理员
- **PROJECT_OWNER** - 项目负责人
- **DEVELOPER** - 开发者
- **VIEWER** - 查看者

### 2. 项目级角色（ProjectMember.role）
- **OWNER** - 项目所有者
- **ADMIN** - 项目管理员
- **MEMBER** - 项目成员
- **VIEWER** - 项目查看者

## 权限矩阵

### 系统级权限（基于 User.role）

#### SUPER_ADMIN（超级管理员）
- ✅ 查看所有项目
- ✅ 查看所有部署记录
- ✅ 创建项目
- ✅ 删除项目（任何项目）
- ✅ 修改项目（任何项目）
- ✅ 添加/删除项目成员（任何项目）
- ✅ 创建/编辑/删除工作流（任何项目）
- ✅ 创建部署（任何项目）
- ✅ 执行部署（任何项目）
- ✅ 取消部署（任何项目）
- ✅ 查看用户列表
- ✅ 添加/编辑/删除用户
- ✅ 修改用户角色和状态
- ✅ 访问权限管理页面
- ✅ 自动审批部署（无需审批流程）

#### PROJECT_OWNER（项目负责人）
- ✅ 查看自己参与的项目
- ✅ 创建项目（自动成为项目 OWNER）
- ✅ 查看部署记录（自己参与的项目）
- ✅ 创建部署（自己参与的项目）
- ❌ 删除项目（除非是项目 OWNER）
- ❌ 修改项目（除非是项目 OWNER 或 ADMIN）
- ❌ 添加/删除项目成员（除非是项目 OWNER 或 ADMIN）
- ❌ 创建/编辑/删除工作流（除非是项目 OWNER 或 ADMIN）
- ❌ 查看用户列表
- ❌ 管理用户
- ✅ 访问权限管理页面（侧边栏可见，但功能受限）

#### DEVELOPER（开发者）
- ✅ 查看自己参与的项目
- ✅ 查看部署记录（自己参与的项目）
- ✅ 创建部署（如果项目角色是 OWNER/ADMIN/MEMBER）
- ❌ 创建项目
- ❌ 删除项目
- ❌ 修改项目（除非是项目 OWNER 或 ADMIN）
- ❌ 添加/删除项目成员
- ❌ 创建/编辑/删除工作流（除非是项目 OWNER 或 ADMIN）
- ❌ 查看用户列表
- ❌ 管理用户
- ❌ 访问权限管理页面

#### VIEWER（查看者）
- ✅ 查看自己参与的项目
- ✅ 查看部署记录（自己参与的项目）
- ❌ 创建项目
- ❌ 删除项目
- ❌ 修改项目
- ❌ 添加/删除项目成员
- ❌ 创建/编辑/删除工作流
- ❌ 创建部署
- ❌ 执行部署
- ❌ 取消部署
- ❌ 查看用户列表
- ❌ 管理用户
- ❌ 访问权限管理页面

### 项目级权限（基于 ProjectMember.role）

#### OWNER（项目所有者）
- ✅ 查看项目详情
- ✅ 修改项目信息
- ✅ 删除项目
- ✅ 添加/删除项目成员
- ✅ 创建/编辑工作流
- ✅ 删除工作流
- ✅ 创建部署
- ✅ 执行部署
- ✅ 取消部署
- ✅ 查看部署日志

#### ADMIN（项目管理员）
- ✅ 查看项目详情
- ✅ 修改项目信息
- ✅ 添加/删除项目成员（不能删除 OWNER）
- ✅ 创建/编辑工作流
- ❌ 删除工作流（只有 OWNER 可以）
- ✅ 创建部署
- ✅ 执行部署
- ✅ 取消部署
- ✅ 查看部署日志

#### MEMBER（项目成员）
- ✅ 查看项目详情
- ✅ 创建部署
- ✅ 执行部署
- ✅ 查看部署日志
- ❌ 修改项目信息
- ❌ 添加/删除项目成员
- ❌ 创建/编辑/删除工作流
- ❌ 取消部署

#### VIEWER（项目查看者）
- ✅ 查看项目详情
- ✅ 查看部署记录
- ✅ 查看部署日志
- ❌ 修改项目信息
- ❌ 添加/删除项目成员
- ❌ 创建/编辑/删除工作流
- ❌ 创建部署
- ❌ 执行部署
- ❌ 取消部署

## 权限检查逻辑

### 系统级权限检查
```typescript
// 超级管理员拥有所有权限
if (user.role === 'SUPER_ADMIN') {
  // 允许所有操作
}
```

### 项目级权限检查
```typescript
// 使用 checkProjectPermission 函数
const hasPermission = user.role === 'SUPER_ADMIN' || 
  await checkProjectPermission(user.userId, projectId, ['OWNER', 'ADMIN'])
```

## 特殊说明

1. **SUPER_ADMIN 权限**：超级管理员拥有所有权限，可以绕过项目级权限检查
2. **项目创建者**：创建项目时自动成为项目的 OWNER
3. **审批流程**：SUPER_ADMIN 和 PROJECT_OWNER 创建的部署会自动审批
4. **工作流删除**：只有项目 OWNER 可以删除工作流
5. **项目删除**：只有项目 OWNER 可以删除项目
6. **成员删除**：不能删除项目 OWNER 角色成员

## 前端权限控制

- **侧边栏菜单**：权限管理页面只对 SUPER_ADMIN 和 PROJECT_OWNER 可见
- **按钮显示**：根据权限动态显示/隐藏操作按钮
- **API 调用**：前端会根据权限条件决定是否调用某些 API
